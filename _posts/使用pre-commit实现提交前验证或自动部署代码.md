---
path: /post/pre-commit-hook
title: ä½¿ç”¨pre-commitå®ç°æäº¤å‰éªŒè¯æˆ–è‡ªåŠ¨éƒ¨ç½²ä»£ç 
date: 2018-03-29 10:20:55
category:
- tools
tags:
- è‡ªåŠ¨åŒ–
- å‰ç«¯å·¥å…·
---

ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæƒ³å¿…æ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„ç¼–ç é£æ ¼ã€‚æœ‰é£æ ¼è™½å¥½ï¼Œä½†è¿™é—®é¢˜ä»¤å¾ˆå¤šé¡¹ç›®ç®¡ç†è€…å¤´ç–¼ï¼Œä¸ä¸€æ ·çš„ä»£ç é£æ ¼åŠç¼©è¿›ï¼Œå¿…ä¼šé™ä½ä»£ç å¯è¯»æ€§ï¼Œä»è€Œé—´æ¥é™ä½æ•ˆç‡ã€‚ä½†æ˜¯è¿™ä¸ªé—®é¢˜éƒ½éš¾ä¸åˆ°æˆ‘ä»¬ä¼Ÿå¤§çš„ç¨‹åºå‘˜ï¼Œå¾ˆå¤šå¦‚eslintï¼Œprettierç­‰åº“çš„å‡ºç°å¸®æˆ‘ä»¬å»è§£å†³é—®é¢˜ã€‚å¾ˆå¤šcliåœ¨ç”Ÿæˆåˆå§‹é¡¹ç›®æ—¶éƒ½ä¼šç»™æˆ‘ä»¬åŠ ä¸Šeslintã€csslintç­‰ï¼Œè¿™ä¸å°±èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜äº†å—ï¼Ÿtoo young too simpleï¼Œæ¯ä¿å­˜ä¸€æ¬¡å°±å¼¹å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¿˜æ˜¯ä¸€å¤§å †è‹±æ–‡ï¼Œä¼°è®¡å¤§éƒ¨åˆ†äººå¿ƒé‡Œå°±é»˜é»˜ä¸€å¥what the fuck is thatäº†ï¼Œä»è€Œå°±å¯¼è‡´æˆ‘ä»¬å˜´ä¸Šè™½å¾ˆå¼ºç¡¬çš„è¯´ç€è¦è§„èŒƒæˆ‘ä»¬çš„ä»£ç é£æ ¼ï¼Œèº«ä½“å´å¾ˆè¯šå®åœ°é»˜é»˜æŠŠå„ç§lintçš„é…ç½®å…³æ‰ğŸ¤·ğŸ¼â€â™‚ï¸ã€‚
æ‰€ä»¥åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œä¼šç»™å¤§å®¶æä¾›ä¸€äº›å¥½ç”¨çš„æ–¹æ³•ï¼Œä½¿å„ä½é‡æ‹¾å®šè§„èŒƒæ—¶å€™çš„æ¿€æƒ…ã€‚

# something useful
1. ä½¿ç”¨`eslint --fix`æ ¼å¼åŒ–æ–‡ä»¶
**eslint**è™½å¥½ï¼Œä½†æ˜¯å¯¹è§„èŒƒè¿˜æ²¡é€‚åº”çš„åŒå­¦å´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œæ¯å†™ä¸€ééƒ½å¼¹ä¸ªé»‘ç™½å±å‡ºæ¥ï¼Œç‰¹åˆ«è‹±æ–‡ä¸å¥½çš„ï¼Œä¼°è®¡åŠå¤©éƒ½ä¸çŸ¥é“å“ªé‡Œå‡ºé—®é¢˜ï¼Œè¿™æ ·å­ä¸‹æ¥ä¼°è®¡åŠå¤©æ²¡å†™å‡ è¡Œä»£ç ã€‚è¿™æ—¶å€™å…¶å®æˆ‘ä»¬å¯ä»¥è´´å¿ƒåœ°æŠŠé…ç½®é¡¹æ³¨é‡Šæ‰ï¼Œåªæœ‰æäº¤å‰è·‘ä¸€ä¸‹`eslint --fix`è¿™ä¸ªå‘½ä»¤å°±å¥½äº†ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ½ä¼šæ ¹æ®è§„èŒƒæ ¼å¼åŒ–æ‰ã€‚

<!-- more -->

2. ä½¿ç”¨å„ç§ç¼–è¾‘å™¨ã€IDEæ’ä»¶
ä¸Šæ–¹æ–¹æ³•è™½å¥½ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è¦ä»æºå¤´ä¸Šè§£å†³é—®é¢˜ï¼ŒåŸ¹å…»æ¯ä¸ªäººçš„ä»£ç é£æ ¼ä»¥åŠä¹ æƒ¯ï¼Œè¿™æ—¶å€™æ’ä»¶å°±èƒ½å¸®ä½æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™åŠæ—¶å‘ç°ï¼Œä¹Ÿä¸ç”¨çœ‹åˆ°ä¸€å¤§ç‰‡é”™è¯¯äº†ã€‚

3. ä½¿ç”¨**prettier**æ ¼å¼åŒ–ä»£ç 
Prettierå¯ä»¥å¸®åŠ©æˆ‘ä»¬åšä¸€äº›ä»£ç æ ¼å¼åŒ–çš„å·¥ä½œï¼Œå¦‚ä»£ç ç¼©è¿›ï¼ŒåŒå¼•å·å˜å•å¼•å·ç­‰ä¸€äº›ä»£ç æ ¼å¼åŒ–å·¥ä½œï¼Œä½†æ˜¯æœ‰äº›é…ç½®é¡¹ä¸eslintæ˜¯é‡å¤çš„ï¼Œä¸‹é¢ä¼šä»‹ç»åˆ°å¦‚ä½•è§£å†³ã€‚å…·ä½“é…ç½®é¡¹å¯ä»¥æŸ¥çœ‹[å®˜ç½‘æ–‡æ¡£](https://prettier.io/docs/en/install.html)ã€‚

è™½ç„¶æœ‰å¾ˆå¤šæ–¹æ³•æé†’æˆ‘ä»¬æ³¨æ„ä»£ç è´¨é‡ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¿™å¹¶ä¸èƒ½é˜»æ­¢æˆ‘ä»¬æŠŠæœ‰linting errorçš„ä»£ç æäº¤åˆ°ä»“åº“ä¸Šã€‚æœ‰æ—¶å€™æ²¡æœ‰ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä½¿ç”¨YUIå‹ç¼©æˆ–è€…å…¶ä»–ä»£ç æ£€æŸ¥å·¥å…·å¯¼è‡´å‘å¸ƒå¤±è´¥ï¼Œæˆ‘ä»¬å°†ä¼šéœ€è¦ç”¨å¤§é‡åœ°æ—¶é—´å»æ‰¾åˆ°nä¸ªäººæäº¤çš„ä»£ç ä¸­çš„1ä¸ªä¸æ˜¾çœ¼çš„è¯­æ³•é”™è¯¯ã€‚

# Pre-commit hook
æ‰€ä»¥ï¼Œä»€ä¹ˆæ˜¯**pre-commit hook**ï¼Ÿå…¶å®Gitç»™æˆ‘é—¨æä¾›äº†å¾ˆå¤šé’©å­ï¼Œæ¯”å¦‚pre-commitè¿™ä¸ªï¼Œå°±æ˜¯æäº¤å‰ï¼Œè¿˜æœ‰æäº¤åï¼Œå…¶ä»–é’©å­å¯è‡ªè¡ŒæŸ¥[Git - Git é’©å­](https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90)ã€‚(SVNæš‚æ—¶æ— èƒ½ä¸ºåŠ›ï¼Œä¸è¿‡Googleä¸­æœ‰æä¾›è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯çœ‹è¿‡ä¸€ä¸‹å®ç°èµ·æ¥é¢‡éº»çƒ¦çš„ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾ä¸€ä¸‹)

## husky + lint-stage
å‡è®¾ä½ çš„é¡¹ç›®ä¸­å·²ç»æœ‰äº†eslintå’Œä½¿ç”¨vueï¼Œç„¶åæˆ‘ä»¬éœ€è¦å®‰è£…ä¸¤ä¸ªpackage

```shell
npm install husky lint-stage --save-dev

// or use yarn
yarn add husky lint-stage -D
```

1. ç„¶ååœ¨`package.json`æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®

```javascript
// package.json
{
// ...
  "script": {
    "lint": "eslint --ext .js,.vue",
    "precommit": "lint-staged"
  },
  "lint-staged": {
    "*.{js|vue}": [
      "npm run lint"
    ]
  }
}
```

2. ç„¶åéšä¾¿æ‰¾ä¸ªæ–‡ä»¶åˆ æ‰ä¸¤ä¸ªç¼©è¿›ç©ºæ ¼ï¼Œç„¶åè·‘ä¸‹æäº¤å‘½ä»¤`git commit -am 'test precommit'`ï¼Œæ­¤æ—¶åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸‹å›¾çš„è¿è¡ŒåŠæŠ¥é”™ã€‚
âš ï¸ è¿™é‡Œçš„é”™è¯¯å¤§å®¶å¯ä»¥çœ‹åˆ°æ˜¯preiiteræŠ›å‡ºçš„ï¼Œæ˜¯å› ä¸ºæˆ‘çš„é…ç½®æ–‡ä»¶å·²ç»é›†æˆäº†prettierï¼Œå¦‚ä½•é›†æˆä¸‹æ–¹æœ‰ä»‹ç»ã€‚
![pre-commit-error]()

å¦‚æœæƒ³ä½¿ç”¨eslintè‡ªåŠ¨ä¿®å¤é”™è¯¯ï¼Œå¯ä»¥ä¿®æ”¹æˆå¦‚ä¸‹é…ç½®

```javascript
// package.json
{
// ...
  "script": {
    "lint": "eslint --fix --ext .js,.vue",
    "precommit": "lint-staged"
  },
  "lint-staged": {
    "*.{js|vue}": [
      "npm run lint",
      "git add"
    ]
  }
}
```

è¿™æ ·ä¿®æ­£å¥½çš„æ–‡ä»¶å°±ä¼šé‡æ–°è·‘ä¸€éaddå‘½ä»¤ï¼Œæˆ‘ä»¬åªéœ€é‡æŒ‰ä¸€ä¸‹â¬†ï¸é”®é‡æ–°è·‘ä¸€ä¸‹å‘½ä»¤æäº¤å³å¯ï¼Œperfectã€‚

## é›†æˆprettierå’ŒJest
1. prettierè™½ç„¶å’Œeslintæœ‰å¾ˆå¤šå…±åŒé…ç½®ï¼Œä½†æ˜¯prettierè¿˜å¯ä»¥å¯¹`vue template`å’Œæ ·å¼æ–‡ä»¶åšéªŒè¯å’Œæ ¼å¼åŒ–ï¼Œæ›´å¤šé…ç½®æ–¹å¼å¯ä»¥æŸ¥çœ‹[æ–‡æ¡£](https://prettier.io/docs/en/index.html)ï¼Œä¸‹é¢åªä»‹ç»å¿«é€Ÿé›†æˆeslintå’Œprettierçš„æ–¹å¼ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…`eslint-plugin-prettier`å’Œ`eslint-config-prettier`

```shell
npm install eslint-plugin-prettier eslint-config-prettier --save-dev
```

ç„¶åä¿®æ”¹æˆ‘ä»¬çš„`.eslintrc.js`

```javascript
{
  "extends": ["plugin:prettier/recommended"]
}
```

ç„¶åé‡æ–°æ‰§è¡Œä¸Šæ–¹é…ç½®çš„ç¬¬äºŒéƒ¨å°±å¯ä»¥çœ‹åˆ°ç»“æœäº†ã€‚

2. é›†æˆJeståšunit testã€‚ä¸ºä»€ä¹ˆè¿™é‡Œä¹Ÿä¼šæŠ½å‡ºå•ç‹¬è®²å‘¢ï¼Œç†è®ºä¸Šæˆ‘ä»¬åªéœ€åœ¨é…ç½®ä¸­åŠ æ®µ`npm run unit`å°±è¡Œäº†ï¼Œä½†æ˜¯è¿è¡Œæ—¶å€™ä¼šå‘ç°Jestä¼šæå‡æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ–‡ä»¶çš„æƒ…å†µã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„npm scriptï¼Œç»™jest cliæ·»åŠ ä¸€ä¸ª`--findRelatedTests`çš„å‚æ•°ã€‚å®˜ç½‘å¯¹è¿™å‚æ•°çš„è§£é‡Šæ˜¯**Useful for pre-commit hook integration to run the minimal amount of tests necessary.** ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ºpre-commitæä¾›çš„ç‰¹æ®Šå‘½ä»¤ï¼Œbut whyğŸ¤·ğŸ¼â€â™‚ï¸
```javascript
{
  ...
  "script": {
    "unit": "jest --config test/jest.conf.js --findRelatedTests",
    "lint": "eslint --fix --ext .js,.vue",
    "precommit": "lint-staged"
  },
  "lint-staged": {
    "*.{js|vue}": [
      "npm run lint",
      "git add",
      "npm run unit"
    ]
  }
}
```

# Last
å‚ç…§ä¸Šé¢å‡ æ­¥ï¼Œä¾¿å¾ˆå®¹æ˜“çš„å®ç°æäº¤å‰éªŒè¯ï¼Œæƒ³æ•´åˆæ‰“åŒ…ç­‰åŠŸèƒ½ä¹Ÿååˆ†ç®€å•ï¼Œåªéœ€è¦åœ¨`lint-stage`ä¸­æ·»åŠ `npm run *`æˆ–è€…é›†æˆå…¶ä»–å‘½ä»¤ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°lint-stageå¯ä»¥é€šè¿‡`glob`çš„è¯­æ³•åŒºåˆ†æ–‡ä»¶ç±»å‹æ‰§è¡Œå¯¹åº”çš„scriptï¼Œå¤§å®¶å¯ä»¥è‡ªç”±å‘æŒ¥å®ç°ä¸€ä¸‹è‡ªåŠ¨éƒ¨ç½²ã€‚

## ç›¸å…³æ–‡æ¡£

* [prettier- Integrating with ESLint](https://prettier.io/docs/en/eslint.html)
* [Husky](https://github.com/typicode/husky/tree/master)
* [lint-stage](https://www.npmjs.com/package/lint-staged)
* [Jest Cli Options](https://facebook.github.io/jest/docs/en/cli.html#findrelatedtests-spaceseparatedlistofsourcefiles)
