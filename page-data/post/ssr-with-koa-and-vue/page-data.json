{"componentChunkName":"component---src-templates-post-tsx","path":"/post/ssr-with-koa-and-vue","result":{"data":{"markdownRemark":{"html":"<p>é˜…è¯»æ­¤æ–‡å‰å»ºè®®å…ˆé˜…è¯»ä¸‹å®˜æ–¹æä¾›çš„æ–‡æ¡£<a href=\"https://ssr.vuejs.org/zh/\">Vue SSRæŒ‡å—</a>ï¼Œå¹¶å¯¹ä»¥ä¸‹å·¥å…·æœ‰ä¸€å®šäº†è§£ã€‚</p>\n<blockquote>\n<p> <a href=\"https://cli.vuejs.org/\">Vue CLI</a> â€” Vueè„šæ‰‹æ¶ï¼Œç”Ÿæˆvueåº”ç”¨æ¨¡æ¿</p>\n<p> <a href=\"https://ssr.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93-ssr-%EF%BC%9F\">Vue SSRæŒ‡å—</a>  â€” å®˜æ–¹SSRæ•™ç¨‹åŠå·¥å…·ä½¿ç”¨æ•™ç¨‹</p>\n<p><a href=\"https://webpack.js.org/\">Webpack</a> â€” å‰ç«¯æ„å»ºå·¥å…·</p>\n<p><a href=\"https://koajs.com/\">Koa</a>  â€” åŸºäºnodejså¼€å‘çš„ç½‘ç»œæ¡†æ¶</p>\n</blockquote>\n<p><a href=\"https://github.com/kitwon/vue-ssr-boilerplate\">ğŸ‘‰ğŸ»å®Œæ•´é¡¹ç›®åœ°å€</a></p>\n<h2>Why do this</h2>\n<p>ç°åœ¨ç¤¾åŒºæœ‰å¾ˆå¤šå¦‚<a href=\"https://zh.nuxtjs.org/\">Nuxt.js</a>ç­‰æ¡†æ¶æˆ–è€…æ’ä»¶ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è‡ªå·±å¼€å‘ä¸€ä¸ªå‘¢ã€‚é¦–å…ˆè‡ªå·±å¼€å‘èƒ½å¯¹å·¥ç¨‹ç»†èŠ‚æœ‰æ›´å¥½çš„æ§åˆ¶ï¼Œè‡ªå®šä¹‰ç¨‹åº¦æ›´é«˜ï¼Œæ¯”å¦‚æˆ‘éœ€è¦åœ¨è·¯ç”±é‡Œé¢åšä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œæˆ–è€…éœ€è¦ç»“åˆredisåšç»„ä»¶ç¼“å­˜ã€‚å…¶æ¬¡è‡ªå·±æ­å»ºèƒ½å¯¹æ¡†æ¶æœ‰ç€æ›´æ·±å…¥çš„ç†è§£ï¼Œå‡ºç°é—®é¢˜ä¹Ÿèƒ½ä»å®¹åº”å¯¹ã€‚</p>\n<!-- more -->\n<h2>å¼€å§‹ç¼–ç å‰</h2>\n<p>æœ¬æ–‡ä¸ä¼šä¸€æ­¥æ­¥è®²å¦‚ä½•é‡æ–°æ­å»ºï¼Œåªä¼šæŒ‘å–ä¸€äº›æ ¸å¿ƒçš„åœ°æ–¹è¿›è¡Œåˆ†æï¼Œå…¶ä»–è¯¦æƒ…è¯·è‡ªè¡ŒæŸ¥é˜…æ–‡æ¡£ã€‚</p>\n<p>å¼€å‘å‰æˆ‘ä»¬éœ€è¦ç¡®è®¤ä¸€ä¸‹å¼€å‘ç¯å¢ƒé‡Œéœ€è¦åŒ…å«çš„åŠŸèƒ½ï¼š</p>\n<ol>\n<li>ä½¿ç”¨Vue-cli3ç”Ÿæˆé¡¹ç›®(å¯é€‰)</li>\n<li>ä½¿ç”¨koaå¯åŠ¨webæœåŠ¡</li>\n<li>å¯åŠ¨webæœåŠ¡æ—¶éœ€è¦åŒæ—¶watch server bundleå’Œclient bundle</li>\n<li>æ”¯æŒHMR(çƒ­æ›´æ–°)</li>\n</ol>\n<h2>ğŸ›  é…ç½®Webpack</h2>\n<p>å› ä¸ºæ˜¯é€‰æ‹©vue-cli3åˆ›å»ºåº”ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦é…ç½®<code class=\"language-text\">vue.config.js</code>ã€‚âš ï¸ ç”±äºæˆ‘åœ¨å¼€å‘çš„æ—¶å€™é€‰æ‹©äº†<strong>TypeScript</strong>ï¼Œæ‰€æœ‰ç›¸å…³çš„ä»£ç è¯·å„ä½è‡ªè¡Œè·³è¿‡ã€‚</p>\n<p>é…ç½®Webpackæœ‰ä»¥ä¸‹å‡ ç‚¹å…³é”®çš„åœ°æ–¹:</p>\n<ul>\n<li>åŒºåˆ†å®¢æˆ·ç«¯å’ŒæœåŠ¡çš„æ„å»ºç¯å¢ƒ</li>\n<li>åˆ é™¤SSRä¸­ä¸éœ€è¦çš„æ’ä»¶</li>\n<li>æ„å»ºæœåŠ¡ç«¯bundleæ—¶å€™éœ€è¦å•ç‹¬è®¾ç½®cache-loaderæ–‡ä»¶å¤¹åŠç¼“å­˜æŒ‡çº¹ã€‚</li>\n</ul>\n<p>é¦–å…ˆæ˜¯åˆ é™¤æ’ä»¶ï¼Œå› ä¸ºé»˜è®¤çš„webpacké…ç½®å¸¦æœ‰ä¸€äº›æ’ä»¶æ˜¯ssrç”¨ä¸ä¸Šçš„ï¼Œå¦‚hmrå’Œpreloadç­‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ é™¤ã€‚å¹¶ä¸”éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨<a href=\"https://www.npmjs.com/package/cross-env\">cross-env</a>åŒºåˆ†ç¯å¢ƒã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">chainWbpack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// åŒºåˆ†ç¯å¢ƒ</span>\n\t<span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SSR_TARGET</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isProd <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isServer <span class=\"token operator\">=</span> target <span class=\"token operator\">===</span> <span class=\"token string\">'server'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// åˆ é™¤ä¸éœ€è¦çš„æ’ä»¶</span>\n  config<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hmr'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  config<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'preload'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  config<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'prefetch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  config<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'progress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isProd<span class=\"token punctuation\">)</span> config<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'no-emit-on-errors'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// HTML</span>\n  <span class=\"token comment\">// ç”Ÿå­˜æ¨¡å¼ä¸‹å…³é—­HTMLå‹ç¼©</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isProd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">plugin</span><span class=\"token punctuation\">(</span><span class=\"token string\">'html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>minify<span class=\"token punctuation\">.</span>removeComments <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> args<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ç„¶åç»§ç»­åœ¨<code class=\"language-text\">vue.config.js</code>ç»§ç»­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œåˆ†åˆ«å¯¹<strong>Server Bundle</strong>å’Œ<strong>Client Bundle</strong>æ„å»ºè¿›è¡Œé…ç½®</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">chainWbpack</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...other config</span>\n  <span class=\"token comment\">//</span>\n\t<span class=\"token comment\">// æ ¹æ®æ„å»ºç¯å¢ƒåŒºåˆ†webpackå…¥å£æ–‡ä»¶</span>\n\tconfig<span class=\"token punctuation\">.</span><span class=\"token function\">entry</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./src/entry-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>target<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.ts</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isServer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// æœåŠ¡ç«¯bundleé…ç½®</span>\n    config<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span><span class=\"token function\">libraryTarget</span><span class=\"token punctuation\">(</span><span class=\"token string\">'commonjs2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">externals</span><span class=\"token punctuation\">(</span><span class=\"token function\">nodeExternals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> whitelist<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token regex\">/\\.css$/</span><span class=\"token punctuation\">,</span> <span class=\"token regex\">/\\?vue&amp;type=style/</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">target</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span>optimization<span class=\"token punctuation\">.</span><span class=\"token function\">splitChunks</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">minimize</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span>plugins<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'friendly-errors'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">plugin</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ssr-server'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueSSRServerPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">plugin</span><span class=\"token punctuation\">(</span><span class=\"token string\">'loader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>WebpackBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Server'</span><span class=\"token punctuation\">,</span> color<span class=\"token punctuation\">:</span> <span class=\"token string\">'orange'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Change cache directory for server-side</span>\n    <span class=\"token comment\">// Server bundle å•ç‹¬åˆ†ç¦»cacheæ–‡ä»¶å¤¹</span>\n    config<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span><span class=\"token function\">rule</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cache-loader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      options<span class=\"token punctuation\">.</span>cacheIdentifier <span class=\"token operator\">+=</span> <span class=\"token string\">'-server'</span><span class=\"token punctuation\">;</span>\n      options<span class=\"token punctuation\">.</span>cacheDirectory <span class=\"token operator\">+=</span> <span class=\"token string\">'-server'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> options<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    config<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span><span class=\"token function\">rule</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-loader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      options<span class=\"token punctuation\">.</span>cacheIdentifier <span class=\"token operator\">+=</span> <span class=\"token string\">'-server'</span><span class=\"token punctuation\">;</span>\n      options<span class=\"token punctuation\">.</span>cacheDirectory <span class=\"token operator\">+=</span> <span class=\"token string\">'-server'</span><span class=\"token punctuation\">;</span>\n      options<span class=\"token punctuation\">.</span>optimizeSSR <span class=\"token operator\">=</span> isServer<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> options<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">plugin</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ssr-client'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueSSRClientPlugin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">plugin</span><span class=\"token punctuation\">(</span><span class=\"token string\">'loader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>WebpackBar<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Client'</span><span class=\"token punctuation\">,</span> color<span class=\"token punctuation\">:</span> <span class=\"token string\">'green'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token function\">devtool</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isProd <span class=\"token operator\">?</span> <span class=\"token string\">'#cheap-module-source-map'</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    config<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span><span class=\"token function\">rule</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-loader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      options<span class=\"token punctuation\">.</span>optimizeSSR <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> options<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>é™¤Webpacké…ç½®å¤–ï¼Œå…¥å£éƒ¨åˆ†ä»£ç é…ç½®è¯·å‚ç…§å®˜æ–¹æ–‡æ¡£ä¸­çš„<a href=\"https://ssr.vuejs.org/zh/guide/universal.html\">ç¼–å†™é€šç”¨ä»£ç </a>ã€<a href=\"https://ssr.vuejs.org/zh/guide/structure.html\">æºç ç»“æ„</a>ã€<a href=\"https://ssr.vuejs.org/zh/guide/routing.html\">è·¯ç”±å’Œä»£ç åˆ†å‰²</a>ã€<a href=\"https://ssr.vuejs.org/zh/guide/data.html\">æ•°æ®é¢„å–å’ŒçŠ¶æ€</a>å‡ ç« ã€‚</p>\n<h2>âš™ï¸ Serveré…ç½®</h2>\n<p>æœåŠ¡é‡Œæ ¸å¿ƒä»£ç ä¸»è¦æœ‰ä»¥ä¸‹3ä¸ªåœ°æ–¹</p>\n<ul>\n<li><code class=\"language-text\">server/ssr.ts</code> â€”â€” å®ä¾‹æ¸²æŸ“æ–¹æ³•åŠè·¯ç”±é…ç½®</li>\n<li><code class=\"language-text\">server/scripts/webpack.ts</code> â€”â€” è·å–Webpacké…ç½®</li>\n<li><code class=\"language-text\">server/scripts/dev-server.ts</code> â€”â€” å¼€å‘ç¯å¢ƒä¸‹WebpackæœåŠ¡</li>\n</ul>\n<h3>æ¸²æŸ“Vueå®ä¾‹</h3>\n<p>SSRä¸­çš„å®ä¾‹æ¸²æŸ“ä»<a href=\"https://ssr.vuejs.org/zh/guide/bundle-renderer.html\">å®˜æ–¹æ–‡æ¡£ä¸­Bundle Renderer</a>å¯çŸ¥ï¼Œä¸€ä¸ªBundle Rendererä¸»è¦åŒ…å«ä»¥ä¸‹3éƒ¨åˆ†</p>\n<ul>\n<li>Template â€”â€” é¡µé¢htmlæ¨¡æ¿</li>\n<li>Server bundle â€”â€” æœåŠ¡ç«¯æ¸²æŸ“æ ¸å¿ƒèµ„æº</li>\n<li>Client manifest â€”â€” å®¢æˆ·ç«¯ä¾èµ–èµ„æº</li>\n</ul>\n<p>ä½†æ˜¯ç”±äºæœ‰å¼€å‘ç¯å¢ƒçš„åŠ å…¥ï¼Œä¸Šæ–¹èµ„æºè·å–ç”±åŸæœ¬çš„æ–‡ä»¶è·å–å˜æˆä»webpackè¿›ç¨‹ä¸­è·å–ï¼Œæ ¸å¿ƒéƒ¨åˆ†ä»£ç å¦‚ä¸‹</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// server/ssr.ts</span>\n<span class=\"token comment\">// Wrap renderToString into the Promise</span>\n<span class=\"token comment\">// renderToStringä½¿ç”¨Promiseå°è£…</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createRouter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">app</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// some code</span>\n  <span class=\"token comment\">//</span>\n  <span class=\"token comment\">// core æ ¸å¿ƒä»£ç </span>\n  <span class=\"token keyword\">let</span> renderer<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isProd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ç”Ÿäº§æ¨¡å¼ä¸‹ç›´æ¥è·å–bundleå¹¶æ¸²æŸ“</span>\n      <span class=\"token keyword\">const</span> template <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>ssr<span class=\"token punctuation\">.</span>template<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> serverBundle <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>ssr<span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> clientManifest <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>ssr<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      renderer <span class=\"token operator\">=</span> <span class=\"token function\">createBundleRenderer</span><span class=\"token punctuation\">(</span>serverBundle<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        template<span class=\"token punctuation\">,</span>\n        clientManifest\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// å¼€å‘æ¨¡å¼ä¸‹ä»webpackä¸­è·å–bundle</span>\n      <span class=\"token comment\">// setupDevServerè¿”å›Promiseï¼ŒonUpdateå›è°ƒè·å–render</span>\n      readyPromise <span class=\"token operator\">=</span> <span class=\"token function\">setupDevServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        server<span class=\"token punctuation\">:</span> app<span class=\"token punctuation\">,</span>\n        templatePath<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">.</span>ssr<span class=\"token punctuation\">.</span>template<span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">onUpdate</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> serverBundle<span class=\"token punctuation\">,</span> options <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          renderer <span class=\"token operator\">=</span> <span class=\"token function\">createBundleRenderer</span><span class=\"token punctuation\">(</span>serverBundle<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Dev Server</h3>\n<p>ä»ä¸Šæ–¹å¯çŸ¥ï¼ŒDevServerä¸­ä¼šæš´éœ²ä¸€ä¸ª<code class=\"language-text\">function setupDevServer(options): Promise&lt;any&gt; {}</code>çš„æ–¹æ³•ï¼Œå¹¶åœ¨onUpdateå›è°ƒä¸­è·å–bundleã€‚ä»<code class=\"language-text\">createBundleRenderer</code>çš„æ–¹æ³•ä¸­çŸ¥é“æˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸¤ä¸ª Webpackå®ä¾‹å»æ„å»ºbundleï¼Œä»ä¸­æ¨æ–­å‡ºdevServerä¸­çš„åŠŸèƒ½åº”æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>\n<ol>\n<li>è·å–clientå’Œserverçš„ Webpacké…ç½®</li>\n<li>æœåŠ¡ä¸­éœ€è¦å¯åŠ¨ä¸¤ä¸ª Webpackå®ä¾‹ï¼Œç­‰å¾…æ„å»ºåresolve bundle files</li>\n<li>æ„å»ºclient bundleæ—¶å€™åŠ å…¥HMR</li>\n</ol>\n<p>è·å–Webpacké…ç½®åªéœ€é€šè¿‡ä¿®æ”¹ä¸¤æ¬¡ç¯å¢ƒå˜é‡å¹¶æ‰§è¡Œ<code class=\"language-text\">service.resolveWebpackConfig</code>è·å–ä¸¤ä»½é…ç½®å¹¶æš´éœ²å‡ºå»ã€‚API è¯·å‚è€ƒvue-serviceçš„æºç ï¼Œå¤‡æ³¨ä¸­æœ‰åœ°å€ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// server/scripts/webpack.ts</span>\n<span class=\"token comment\">/* eslint import/no-extraneous-dependencies: 0 */</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> join <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Refer to the source code from cli-service\n * https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli-service/lib/PluginAPI.js#L137\n */</span>\n<span class=\"token keyword\">const</span> Service <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@vue/cli-service/lib/Service'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> service <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Service</span><span class=\"token punctuation\">(</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'../..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nservice<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">||</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nprocess<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SSR_TARGET</span> <span class=\"token operator\">=</span> <span class=\"token string\">'client'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> clientConfig <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">resolveWebpackConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nprocess<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SSR_TARGET</span> <span class=\"token operator\">=</span> <span class=\"token string\">'server'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> serverConfig <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">resolveWebpackConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span>\n  clientConfig<span class=\"token punctuation\">,</span>\n  serverConfig\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>DevServerçš„é€»è¾‘ä¹Ÿä¸å¤æ‚ï¼Œé‡Œé¢ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒå†…å®¹ï¼š</p>\n<ol>\n<li>setupDevServerè¿”å›ä¸€ä¸ªPromiseï¼Œæ„å»ºå®Œæˆæ—¶å€™resolveï¼Œrouterä¸­éœ€è¦æ ¹æ®è¿™ä¸ªçŠ¶æ€è¿”å›ç»“æœã€‚</li>\n<li>æ ¸å¿ƒ<code class=\"language-text\">update()</code>æ–¹æ³•ï¼Œå½“webpackæ„å»ºæˆåŠŸæ—¶å€™æ‰§è¡Œè¿™ä¸ªå›è°ƒæ–¹æ³•ï¼Œç„¶åæŠŠæ„å»ºç”Ÿæˆçš„åŒ…è¿”å›å‡ºå»</li>\n<li>client compilerä¸­æ·»åŠ HMRçƒ­æ›´æ–°æ’ä»¶</li>\n<li>server compilerä¸­æŠŠoutputFileSystemä¿®æ”¹ä¸º<strong>memory-fs</strong>ï¼ŒæŠŠæ„å»ºçš„å†…å®¹å†™å…¥åˆ°å†…å­˜é‡Œé¢</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// server/scripts/dev-server.ts</span>\n<span class=\"token comment\">//</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">setupDevServer</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token punctuation\">{</span> server<span class=\"token punctuation\">,</span> templatePath<span class=\"token punctuation\">,</span> onUpdate <span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span> DevOptions</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 1. è¿”å›ä¸€ä¸ªpromise</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">//</span>\n    <span class=\"token comment\">// 2. æ„å»ºæˆåŠŸå›è°ƒï¼Œresolveä¹Ÿåœ¨è¿™ä¸€æ­¥å®Œæˆ #53</span>\n    <span class=\"token comment\">// HMR update callback</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">update</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>serverBundle <span class=\"token operator\">&amp;&amp;</span> clientManifest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">onUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          serverBundle<span class=\"token punctuation\">,</span>\n          options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            template<span class=\"token punctuation\">,</span>\n            clientManifest\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// 3. æ·»åŠ çƒ­æ›´æ–°æ’ä»¶ï¼Œæ„å»ºå…¥å£åŠ ä¸ŠHMRçš„æ–‡ä»¶ #73</span>\n    clientConfig<span class=\"token punctuation\">.</span>entry<span class=\"token punctuation\">.</span>app <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'webpack-hot-middleware/client'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>clientConfig<span class=\"token punctuation\">.</span>entry<span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//</span>\n    <span class=\"token comment\">// è®¾ç½®webpackå¼€å‘ä¸­é—´ä»¶ #77</span>\n    <span class=\"token keyword\">const</span> clientCompiler <span class=\"token operator\">=</span> <span class=\"token function\">webpack</span><span class=\"token punctuation\">(</span>clientConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> middleware <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">koaWebpack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      compiler<span class=\"token punctuation\">:</span> clientCompiler<span class=\"token punctuation\">,</span>\n      devMiddleware<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        publicPath<span class=\"token punctuation\">:</span> clientConfig<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>publicPath<span class=\"token punctuation\">,</span>\n        stats<span class=\"token punctuation\">:</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">,</span>\n        logLevel<span class=\"token punctuation\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span>\n        index<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// æ·»åŠ çƒ­æ›´æ–°ä¸­é—´ä»¶ #120</span>\n    server<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">e2k</span><span class=\"token punctuation\">(</span><span class=\"token function\">webpackHotMiddleware</span><span class=\"token punctuation\">(</span>clientCompiler<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> heartbeat<span class=\"token punctuation\">:</span> <span class=\"token number\">5000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// 3. Server compiler outputFileSystemä¿®æ”¹ä¸ºmemory-fs #125</span>\n    <span class=\"token keyword\">const</span> serverCompiler <span class=\"token operator\">=</span> <span class=\"token function\">webpack</span><span class=\"token punctuation\">(</span>serverConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> serverMfs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MFS</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    serverCompiler<span class=\"token punctuation\">.</span>outputFileSystem <span class=\"token operator\">=</span> serverMfs<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>ğŸ–ŠConclusion</h2>\n<p>é€šè¿‡å¯¹SSR devå¼€å‘ç¯å¢ƒçš„æ­å»ºèƒ½å¯¹æœåŠ¡ç«¯æ¸²æŸ“çš„åŠŸèƒ½æ›´ä¸ºäº†è§£ï¼Œä½†æ˜¯æ›´å¤šçš„ä¼˜åŒ–å¦‚critical cssçš„æå–ï¼Œç»„ä»¶ç¼“å­˜ç­‰åŠŸèƒ½è¿˜éœ€è¦ä¼˜åŒ–ï¼Œå¦å¤–SSRæ˜¯æœåŠ¡å™¨å¯†é›†å‹çš„åŠŸèƒ½ï¼Œæ›´å¤šçš„ä¼˜åŒ–ç‚¹è¿˜æ˜¯è¦ç»“åˆä¸šåŠ¡å’Œå®æˆ˜å»å®è·µçš„ã€‚</p>\n<p>å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æ­å»ºSSRç¯å¢ƒæˆ–è€…é€‰å‹ä¸­æœ‰å¸®åŠ©ã€‚Thanks â¤ï¸</p>","frontmatter":{"date":"July 27, 2019","path":"/post/ssr-with-koa-and-vue","title":"ä½¿ç”¨Koa + vue-cli3æ­å»ºSSR å¼€å‘ç¯å¢ƒ","category":["å‰ç«¯"]},"headings":[{"depth":2,"value":"Why do this"},{"depth":2,"value":"å¼€å§‹ç¼–ç å‰"},{"depth":2,"value":"ğŸ›  é…ç½®Webpack"},{"depth":2,"value":"âš™ï¸ Serveré…ç½®"},{"depth":3,"value":"æ¸²æŸ“Vueå®ä¾‹"},{"depth":3,"value":"Dev Server"},{"depth":2,"value":"ğŸ–ŠConclusion"}],"tableOfContents":"<ul>\n<li><a href=\"/post/ssr-with-koa-and-vue/#why-do-this\">Why do this</a></li>\n<li><a href=\"/post/ssr-with-koa-and-vue/#%E5%BC%80%E5%A7%8B%E7%BC%96%E7%A0%81%E5%89%8D\">å¼€å§‹ç¼–ç å‰</a></li>\n<li><a href=\"/post/ssr-with-koa-and-vue/#-%E9%85%8D%E7%BD%AEwebpack\">ğŸ›  é…ç½®Webpack</a></li>\n<li>\n<p><a href=\"/post/ssr-with-koa-and-vue/#%EF%B8%8F-server%E9%85%8D%E7%BD%AE\">âš™ï¸ Serveré…ç½®</a></p>\n<ul>\n<li><a href=\"/post/ssr-with-koa-and-vue/#%E6%B8%B2%E6%9F%93vue%E5%AE%9E%E4%BE%8B\">æ¸²æŸ“Vueå®ä¾‹</a></li>\n<li><a href=\"/post/ssr-with-koa-and-vue/#dev-server\">Dev Server</a></li>\n</ul>\n</li>\n<li><a href=\"/post/ssr-with-koa-and-vue/#conclusion\">ğŸ–ŠConclusion</a></li>\n</ul>"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/ssr-with-koa-and-vue","next":{"frontmatter":{"title":"What's AST & How AST","date":"2019-05-25","category":["javascript"],"tags":["babel","AST"],"path":"/post/what-and-how-ast"}},"previous":{"frontmatter":{"title":"ä½¿ç”¨Webpackè®¾è®¡ä¸€ä¸ªæ‰€æœ‰é¡¹ç›®é€‚ç”¨çš„åˆ†åŒ…é…ç½®","date":"2019-09-06","category":["å‰ç«¯"],"tags":["webpack","æ€§èƒ½ä¼˜åŒ–"],"path":"/post/webpack-bundle-design"}}}}}